<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/dsframeworks/Storyboard-Maker/refs/heads/main/favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storyboard Creator Pro</title>
    
    <!-- PURE jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* CSS Variables for Light/Dark Mode */
        :root {
            --bg-color: #f4f7f6;
            --navbar-bg: #ffffff;
            --text-main: #2c3e50;
            --modal-bg: #ffffff;
            --border-color: #e0e0e0;
            --accent-color: #3498db;
            --nav-shadow: 0 2px 10px rgba(0,0,0,0.08);
            --line-height: 32px;

            /* Page/Layout Variables */
            --page-bg: #ffffff;
            --page-text: #333333;
            --panel-bg: #ffffff;
            --image-bg: #fafafa;
            --input-border: #999999;
            --check-bg: #000000;
            --check-tick: #ffffff;
            --muted-text: #777777;
        }

        /* Dark Theme */
        body.dark-theme {
            --bg-color: #131314;        
            --navbar-bg: #1e1f20;       
            --text-main: #e3e3e3;       
            --modal-bg: #1e1f20;        
            --border-color: #444746;    
            --nav-shadow: 0 2px 10px rgba(0,0,0,0.5);
            --page-bg: #1e1f20;         
            --page-text: #e3e3e3;       
            --panel-bg: #131314;        
            --image-bg: #131314;        
            --input-border: #444746;    
            --check-bg: #e3e3e3;        
            --check-tick: #1e1f20;      
            --muted-text: #c4c7c5;      
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            margin: 0;
            padding: 80px 20px 40px 20px; 
            font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- PROFESSIONAL NAVBAR --- */
        .navbar {
            position: fixed;
            top: 0; left: 0; right: 0; height: 60px;
            background-color: var(--navbar-bg);
            box-shadow: var(--nav-shadow);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 25px; z-index: 1000;
            transition: transform 0.3s ease, background-color 0.3s, box-shadow 0.3s;
        }

        .navbar.hidden { transform: translateY(-100%); }

        .navbar-brand {
            font-size: 20px; font-weight: 700; color: var(--text-main);
            display: flex; align-items: center; gap: 10px;
            transition: color 0.3s;
        }

        .controls { display: flex; gap: 15px; align-items: center; }

        .btn {
            background-color: #2c3e50; color: #fff; border: none; padding: 8px 16px;
            font-size: 14px; font-weight: 500; border-radius: 6px; cursor: pointer;
            transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { filter: brightness(1.2); transform: translateY(-1px); }
        .btn:active { transform: translateY(1px); }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; }

        .btn-icon {
            background-color: transparent; color: var(--text-main); padding: 8px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: none; cursor: pointer; transition: background 0.2s; position: relative;
        }
        .btn-icon:hover { background-color: rgba(128,128,128,0.15); transform: none; }
        .btn-icon:active { transform: scale(0.95); }

        .badge {
            position: absolute; top: 4px; right: 4px; width: 8px; height: 8px;
            background-color: #e74c3c; border-radius: 50%; display: none;
            border: 2px solid var(--navbar-bg);
        }

        .menu-container { position: relative; display: flex; align-items: center; }
        
        .profile-btn {
            background: transparent; border: none; cursor: pointer; padding: 0;
            border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center;
            width: 38px; height: 38px; transition: box-shadow 0.2s; border: 2px solid var(--border-color);
        }
        .profile-btn:hover { box-shadow: 0 0 0 3px rgba(128,128,128,0.2); }
        .profile-btn img { width: 100%; height: 100%; object-fit: cover; }
        
        .dropdown-menu {
            display: none; position: absolute; right: 0; top: 100%; margin-top: 10px; width: 230px;
            background: var(--modal-bg); box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-radius: 8px; overflow: hidden; z-index: 1001; border: 1px solid var(--border-color);
        }
        .dropdown-menu.show { display: flex; flex-direction: column; }
        
        .notif-menu { width: 300px; max-height: 400px; display: none; flex-direction: column; }
        .notif-menu.show { display: flex; }
        .notif-header { padding: 15px; border-bottom: 1px solid var(--border-color); font-weight: bold; color: var(--text-main); display: flex; justify-content: space-between; align-items: center;}
        .notif-clear { font-size: 12px; color: var(--accent-color); cursor: pointer; font-weight: normal; }
        .notif-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .notif-item { padding: 12px 15px; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 4px; }
        .notif-item .msg { font-size: 13px; color: var(--text-main); }
        .notif-item .time { font-size: 11px; color: var(--muted-text); }
        .notif-empty { padding: 20px; text-align: center; color: var(--muted-text); font-size: 13px; }

        .dropdown-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: none; }
        .user-name { display: block; font-weight: 600; color: var(--text-main); font-size: 14px; margin-bottom: 2px; }
        .user-email { display: block; font-size: 12px; color: var(--muted-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .dropdown-item {
            padding: 12px 15px; color: var(--text-main); text-decoration: none;
            font-size: 14px; cursor: pointer; transition: background 0.2s;
            display: flex; align-items: center; gap: 12px;
        }
        .dropdown-item:hover { background: rgba(128,128,128,0.1); }
        .dropdown-item svg { flex-shrink: 0; }
        
        #btn-logout { color: #e74c3c; display: none; }
        #btn-logout:hover { background: rgba(231, 76, 60, 0.1); }

        /* Floating Action Button */
        .fab-add {
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
            background-color: var(--accent-color); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 1050;
            border: none; transition: transform 0.2s, background 0.2s;
        }
        .fab-add:hover { transform: scale(1.05); background-color: #2980b9; }
        .fab-add:active { transform: scale(0.95); }

        /* Icon Only Delete Button */
        .delete-page-btn {
            position: absolute; top: 15px; right: 15px; background-color: #e74c3c;
            color: white; border: none; width: 34px; height: 34px;
            border-radius: 50%; cursor: pointer; z-index: 10;
            display: flex; align-items: center; justify-content: center;
            padding: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s, background-color 0.2s;
        }
        .delete-page-btn:hover { background-color: #c0392b; transform: scale(1.1); }
        .page:first-child .delete-page-btn { display: none; }

        #storyboard-container {
            display: flex; flex-direction: column; gap: 30px;
            width: 100%; max-width: 210mm; align-items: center;
        }

        /* --- PAGE STYLING --- */
        .page {
            width: 210mm; height: 297mm; 
            background: var(--page-bg); color: var(--page-text);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); padding: 15mm; display: flex;
            flex-direction: column; position: relative;
            transition: background 0.3s, color 0.3s;
            box-sizing: border-box;
        }
        .header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 5mm; padding-bottom: 5mm; height: 20mm; }
        .header-group { display: flex; align-items: baseline; }
        .header-label { font-size: 14px; color: var(--muted-text); margin-right: 10px; text-transform: uppercase; letter-spacing: 0.5px; transition: color 0.3s;}
        .header-input {
            border: none; border-bottom: 1px solid var(--input-border); outline: none;
            font-size: 16px; padding: 2px 5px; background: transparent; color: var(--page-text);
            transition: border-color 0.3s, color 0.3s; font-weight: bold;
        }
        .input-project { width: 200px; } .input-scene { width: 150px; } .input-page { width: 40px; text-align: center; }
        .page-divider { margin: 0 10px; color: var(--muted-text); font-size: 14px; font-weight: bold;}

        .panels-wrapper { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .panel { height: 31%; display: flex; flex-direction: column; }
        .panel-top { display: flex; border: 1px solid var(--input-border); border-bottom: none; height: 30px; background: var(--panel-bg); transition: background 0.3s, border-color 0.3s; }
        .shot-box { display: flex; align-items: center; border-right: 1px solid var(--input-border); padding: 0 10px; width: 140px; transition: border-color 0.3s; }
        .shot-box span { font-size: 12px; color: var(--muted-text); font-weight: bold; transition: color 0.3s; }
        .shot-input { flex: 1; border: none; outline: none; margin-left: 8px; font-size: 14px; width: 100%; color: var(--page-text); background: transparent; font-weight: bold; transition: color 0.3s;}

        .checkboxes { display: flex; align-items: center; padding: 0 15px; gap: 15px; flex: 1; }
        .checkboxes label { font-size: 12px; color: var(--page-text); display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: bold; transition: color 0.3s; }
        .checkboxes input[type="checkbox"] {
            appearance: none; -webkit-appearance: none; width: 14px; height: 14px;
            border: 1px solid var(--input-border); border-radius: 2px; background-color: var(--page-bg); cursor: pointer; position: relative; margin: 0;
            transition: background 0.3s, border-color 0.3s;
        }
        .checkboxes input[type="checkbox"]:checked { background-color: var(--check-bg); border-color: var(--check-bg); }
        .checkboxes input[type="checkbox"]:checked::after {
            content: ''; position: absolute; left: 4px; top: 1px; width: 3px; height: 7px;
            border: solid var(--check-tick); border-width: 0 2px 2px 0; transform: rotate(45deg);
        }

        .panel-body { display: flex; flex: 1; border: 1px solid var(--input-border); min-height: 0; transition: border-color 0.3s; }
        .image-container {
            flex: 0 0 55%; border-right: 1px solid var(--input-border); position: relative; cursor: pointer;
            display: flex; justify-content: center; align-items: center; background-color: var(--image-bg); overflow: hidden;
            transition: background 0.3s, border-color 0.3s;
        }
        .image-container:hover { filter: brightness(0.95); }
        .image-container::before { content: 'Click to select image'; position: absolute; color: var(--muted-text); font-size: 14px; pointer-events: none; transition: color 0.3s; }
        .image-container.has-image::before { display: none; }
        .image-container img { position: absolute; top: 0; bottom: 0; left: 0; right: 0; margin: auto; max-width: 100%; max-height: 100%; width: 100%; height: 100%; object-fit: contain; pointer-events: none; }

        .notes-container { flex: 1; display: flex; flex-direction: column; padding: 10px; position: relative; min-width: 0; }
        .notes-heading { font-weight: bold; font-size: 14px; color: var(--muted-text); margin-bottom: 5px; transition: color 0.3s; }
        .notes-textarea {
            flex: 1; background: transparent; border: none; resize: none; outline: none; line-height: var(--line-height);
            font-family: inherit; font-size: 14px; color: var(--page-text); overflow: hidden; margin-bottom: 15px; 
            white-space: pre-wrap; word-wrap: break-word; font-weight: 500; transition: color 0.3s;
        }
        .word-counter { position: absolute; bottom: 8px; right: 12px; font-size: 11px; color: var(--page-text); opacity: 0.5; pointer-events: none; transition: color 0.3s; }

        /* Modals Styling */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); z-index: 3000; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal-box {
            background: var(--modal-bg); color: var(--text-main); padding: 25px 30px; 
            border-radius: 12px; text-align: left; width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 90%;
            border: 1px solid var(--border-color);
            transition: background 0.3s, border-color 0.3s, color 0.3s;
            display: flex; flex-direction: column;
        }
        .modal-box h3 { display: flex; align-items: center; gap: 10px; margin: 0 0 15px 0; font-size: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;}
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px;}

        .file-list { max-height: 250px; overflow-y: auto; margin-top: 15px; border: 1px solid var(--border-color); border-radius: 6px; }
        .file-item { padding: 12px 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: var(--text-main); transition: background 0.2s; font-size: 14px; }
        .file-item:last-child { border-bottom: none; }
        .file-item:hover { background: rgba(128,128,128,0.1); }
        .no-files-msg { color: #e74c3c; font-size: 14px; text-align: center; padding: 20px 0; display: none; }

        .custom-input { width: 100%; padding: 10px; margin-top: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-main); font-size: 16px; outline: none; transition: background 0.3s, border-color 0.3s, color 0.3s; }
        .custom-input:focus { border-color: var(--accent-color); }

        .setting-group { margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .setting-group label { font-size: 15px; font-weight: 500; display: flex; align-items: center; gap: 10px; }
        .setting-group select { padding: 6px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-main); font-size: 14px; outline: none; transition: background 0.3s, color 0.3s, border-color 0.3s;}
        
        .switch { position: relative; display: inline-block; width: 46px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(22px); }

        #loading-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 5000; align-items: center; justify-content: center; flex-direction: column; color: white; font-size: 18px; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid white; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 12px 16px; position: fixed; z-index: 5000; bottom: 30px; right: 30px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.5s, bottom 0.5s; display: flex; align-items: center; justify-content: center; gap: 8px;}
        #toast.show { visibility: visible; opacity: 1; bottom: 40px; }

        .pdf-modal-box { width: 90%; max-width: 900px; height: 90vh; display: flex; flex-direction: column; padding: 20px; }
        #pdf-iframe { flex: 1; border: 1px solid var(--border-color); border-radius: 6px; margin: 15px 0; background: #fff; width: 100%; }
        .pdf-mobile-msg { display: none; flex-direction: column; align-items: center; justify-content: center; flex: 1; text-align: center; color: var(--text-main); }
        .pdf-mobile-msg svg { width: 64px; height: 64px; color: var(--accent-color); margin-bottom: 20px; }

        @media (max-width: 800px) {
            body { padding-top: 130px; } 
            .navbar { flex-direction: column; height: auto; padding: 15px; gap: 15px; }
            .controls { flex-wrap: wrap; justify-content: center; }
            .page { width: 100%; height: auto; padding: 15px; margin-bottom: 10px; }
            .header { flex-direction: column; align-items: flex-start; height: auto; gap: 15px; padding-bottom: 15px; }
            .header-group { width: 100%; justify-content: space-between; }
            .input-project, .input-scene { width: 60%; text-align: right; }
            .panel { height: auto; margin-bottom: 25px; }
            .panel-top { flex-direction: column; height: auto; }
            .shot-box { width: 100%; border-right: none; border-bottom: 1px solid var(--input-border); padding: 10px; justify-content: space-between; }
            .checkboxes { flex-wrap: wrap; padding: 12px; gap: 12px; justify-content: center; }
            .panel-body { flex-direction: column; }
            .image-container { flex: none; width: 100%; height: 250px; border-right: none; border-bottom: 1px solid var(--input-border); }
            .notes-container { flex: none; width: 100%; min-height: 180px; }
            .fab-add { bottom: 20px; right: 20px; width: 50px; height: 50px; }
            #toast.show { bottom: 80px; }
            
            #pdf-iframe { display: none; }
            .pdf-mobile-msg { display: flex; }
            .pdf-modal-box { height: auto; min-height: 60vh; }
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar" id="main-navbar">
        <div class="navbar-brand" id="app-heading">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--accent-color)">
                <path d="M20.2 6 3 11l-.9-2.4c-.3-1.1.4-2.2 1.5-2.5l13.5-4c1.1-.3 2.2.4 2.5 1.5l.6 2.4z"/>
                <path d="m2.6 10.1 18.5 5.5"/><path d="m5 6 2.6 7.4"/><path d="m9.2 4.8 2.6 7.4"/>
                <path d="m13.4 3.5 2.6 7.4"/><path d="m17.6 2.2 2.6 7.4"/>
                <path d="M4 14h16a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2z"/>
            </svg>
            <span id="app-heading-text">Storyboard Maker</span>
        </div>
        <div class="controls">
            <input type="file" id="loadSbpInput" accept=".sbp" style="display: none;" onchange="loadProjectFile(event)">
            
            <button class="btn-icon" onclick="initiateDriveSave()" title="Save to Drive">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                    <path d="M8.36 2L1 14.82L4.65 21L12.01 8.18L8.36 2Z" fill="#3682F4"/>
                    <path d="M23 14.82L15.64 2H8.36L15.72 14.82H23Z" fill="#FFC100"/>
                    <path d="M19.35 21L23 14.82H8.28L4.63 21H19.35Z" fill="#00A551"/>
                </svg>
            </button>
            
            <!-- EXPORT PURE JSPDF BUTTON -->
            <button class="btn-icon" id="pdf-btn" onclick="generatePurePDF()" title="Export PDF">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <path d="M12 18v-6"/>
                    <path d="M9 15l3 3 3-3"/>
                </svg>
            </button>

            <!-- Notifications -->
            <div class="menu-container">
                <button class="btn-icon" onclick="toggleMenu(event, 'notifMenu')" title="Notifications">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                    <span class="badge" id="notif-badge"></span>
                </button>
                <div class="dropdown-menu notif-menu" id="notifMenu">
                    <div class="notif-header">Notifications<span class="notif-clear" onclick="clearNotifications()">Clear</span></div>
                    <div class="notif-list" id="notif-list"><div class="notif-empty">No notifications yet</div></div>
                </div>
            </div>

            <!-- Profile & Menu -->
            <div class="menu-container">
                <button class="profile-btn" onclick="toggleMenu(event, 'dropdownMenu')" title="Profile & Menu">
                    <img id="nav-profile-pic" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='38' height='38' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'></path><circle cx='12' cy='7' r='4'></circle></svg>" alt="Profile">
                </button>
                <div class="dropdown-menu" id="dropdownMenu">
                    <div class="dropdown-header" id="user-info-section">
                        <span class="user-name" id="user-name">Name</span>
                        <span class="user-email" id="user-email">email@google.com</span>
                    </div>

                    <a class="dropdown-item" id="btn-login" onclick="signInToGoogle()">
                        <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
                        <span>Sign In with Google</span>
                    </a>
                    
                    <a class="dropdown-item" onclick="openFromDrive()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-1.2-1.2A2 2 0 0 0 7.55 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/><path d="M2 10h20"/></svg>
                        <span>Open Project</span>
                    </a>

                    <a class="dropdown-item" onclick="openSettings()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                        <span>Settings</span>
                    </a>

                    <a class="dropdown-item" id="btn-logout" onclick="signOutFromGoogle()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        <span>Sign Out</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <button class="fab-add" onclick="addPage()" title="Add New Page">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>

    <!-- Template Page -->
    <div id="page-template" style="display:none;">
        <div class="page">
            <button class="delete-page-btn" onclick="deletePage(this)" title="Delete Page">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
            </button>
            <div class="header">
                <div class="header-group"><span class="header-label">PROJECT</span><input type="text" class="header-input input-project"></div>
                <div class="header-group"><span class="header-label">SCENE</span><input type="text" class="header-input input-scene"></div>
                <div class="header-group"><span class="header-label">PAGE</span><input type="text" class="header-input input-page page-num" readonly><span class="page-divider">of</span><input type="text" class="header-input input-page page-total" readonly></div>
            </div>
            <div class="panels-wrapper">
                <div class="panel" data-panel="1">
                    <div class="panel-top">
                        <div class="shot-box"><span>SHOT #:</span><input type="text" class="shot-input"></div>
                        <div class="checkboxes">
                            <label><input type="checkbox" value="ECU" onchange="handleSingleSelect(this)"> ECU</label>
                            <label><input type="checkbox" value="CU" onchange="handleSingleSelect(this)"> CU</label>
                            <label><input type="checkbox" value="MCU" onchange="handleSingleSelect(this)"> MCU</label>
                            <label><input type="checkbox" value="MS" onchange="handleSingleSelect(this)"> MS</label>
                            <label><input type="checkbox" value="WS" onchange="handleSingleSelect(this)"> WS</label>
                            <label><input type="checkbox" value="EWS" onchange="handleSingleSelect(this)"> EWS</label>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="image-container" onclick="this.querySelector('input').click()">
                            <input type="file" accept="image/*" style="display:none" onchange="handleImageUpload(event, this.parentElement)">
                            <img style="display:none;">
                        </div>
                        <div class="notes-container">
                            <div class="notes-heading">Scene Description:</div>
                            <textarea class="notes-textarea" spellcheck="false" oninput="handleText(this)"></textarea>
                            <div class="word-counter">0/200</div>
                        </div>
                    </div>
                </div>
                <div class="panel" data-panel="2">
                    <div class="panel-top">
                        <div class="shot-box"><span>SHOT #:</span><input type="text" class="shot-input"></div>
                        <div class="checkboxes">
                            <label><input type="checkbox" value="ECU" onchange="handleSingleSelect(this)"> ECU</label>
                            <label><input type="checkbox" value="CU" onchange="handleSingleSelect(this)"> CU</label>
                            <label><input type="checkbox" value="MCU" onchange="handleSingleSelect(this)"> MCU</label>
                            <label><input type="checkbox" value="MS" onchange="handleSingleSelect(this)"> MS</label>
                            <label><input type="checkbox" value="WS" onchange="handleSingleSelect(this)"> WS</label>
                            <label><input type="checkbox" value="EWS" onchange="handleSingleSelect(this)"> EWS</label>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="image-container" onclick="this.querySelector('input').click()">
                            <input type="file" accept="image/*" style="display:none" onchange="handleImageUpload(event, this.parentElement)">
                            <img style="display:none;">
                        </div>
                        <div class="notes-container">
                            <div class="notes-heading">Scene Description:</div>
                            <textarea class="notes-textarea" spellcheck="false" oninput="handleText(this)"></textarea>
                            <div class="word-counter">0/200</div>
                        </div>
                    </div>
                </div>
                <div class="panel" data-panel="3">
                    <div class="panel-top">
                        <div class="shot-box"><span>SHOT #:</span><input type="text" class="shot-input"></div>
                        <div class="checkboxes">
                            <label><input type="checkbox" value="ECU" onchange="handleSingleSelect(this)"> ECU</label>
                            <label><input type="checkbox" value="CU" onchange="handleSingleSelect(this)"> CU</label>
                            <label><input type="checkbox" value="MCU" onchange="handleSingleSelect(this)"> MCU</label>
                            <label><input type="checkbox" value="MS" onchange="handleSingleSelect(this)"> MS</label>
                            <label><input type="checkbox" value="WS" onchange="handleSingleSelect(this)"> WS</label>
                            <label><input type="checkbox" value="EWS" onchange="handleSingleSelect(this)"> EWS</label>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="image-container" onclick="this.querySelector('input').click()">
                            <input type="file" accept="image/*" style="display:none" onchange="handleImageUpload(event, this.parentElement)">
                            <img style="display:none;">
                        </div>
                        <div class="notes-container">
                            <div class="notes-heading">Scene Description:</div>
                            <textarea class="notes-textarea" spellcheck="false" oninput="handleText(this)"></textarea>
                            <div class="word-counter">0/200</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="storyboard-container"></div>

    <!-- Modals -->
    <div id="save-name-modal" class="modal-overlay">
        <div class="modal-box" style="width: 350px;">
            <h3>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M8.36 2L1 14.82L4.65 21L12.01 8.18L8.36 2Z" fill="#3682F4"/><path d="M23 14.82L15.64 2H8.36L15.72 14.82H23Z" fill="#FFC100"/><path d="M19.35 21L23 14.82H8.28L4.63 21H19.35Z" fill="#00A551"/></svg>
                Save to Drive
            </h3>
            <p style="font-size: 14px; margin-bottom: 5px;">Enter Project Name:</p>
            <input type="text" id="driveFileNameInput" class="custom-input" placeholder="e.g. My Awesome Film">
            <div class="modal-actions">
                <button class="btn" style="background: var(--border-color); color: var(--text-main);" onclick="closeSaveNameModal()">Cancel</button>
                <button class="btn" style="background: var(--accent-color);" onclick="confirmDriveSave()">Save Project</button>
            </div>
        </div>
    </div>

    <div id="open-drive-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-1.2-1.2A2 2 0 0 0 7.55 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/><path d="M2 10h20"/></svg>
                Open Project
            </h3>
            <p class="no-files-msg" id="no-files-msg">No projects found in your Google Drive. Please create and save a project first.</p>
            <div class="file-list" id="drive-files-list"></div>
            <div class="modal-actions">
                <button class="btn" style="background: var(--border-color); color: var(--text-main);" onclick="closeOpenModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="modal-box" style="text-align: center; width: 350px;">
            <h3 style="justify-content:center;">Delete Page?</h3>
            <p style="font-size: 14px; margin-bottom: 20px;">Are you sure you want to delete this page?</p>
            <div class="modal-actions" style="justify-content: center;">
                <button class="btn" style="background: var(--border-color); color: var(--text-main);" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn" style="background: #e74c3c;" onclick="confirmDeletePage()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                Settings
            </h3>
            
            <div class="setting-group">
                <label><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg> Dark Theme</label>
                <label class="switch"><input type="checkbox" id="darkThemeToggle"><span class="slider"></span></label>
            </div>

            <div class="setting-group">
                <label><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg> Auto-Save</label>
                <label class="switch"><input type="checkbox" id="autoSaveToggle"><span class="slider"></span></label>
            </div>

            <div class="setting-group">
                <label><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 9h16"/><path d="M4 15h16"/><path d="M10 3L8 21"/><path d="M16 3l-2 18"/></svg> Auto Shot Number</label>
                <label class="switch"><input type="checkbox" id="autoShotToggle"><span class="slider"></span></label>
            </div>

            <div class="setting-group">
                <label><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Interval</label>
                <select id="autoSaveInterval">
                    <option value="1">1 Minute</option>
                    <option value="3">3 Minutes</option>
                    <option value="5">5 Minutes</option>
                    <option value="10">10 Minutes</option>
                </select>
            </div>

            <p style="font-size: 12px; opacity: 0.7; margin-top: 10px;">
                * Auto-save is active only after saving manually for the first time.
            </p>

            <div class="modal-actions">
                <button class="btn" style="background: var(--border-color); color: var(--text-main);" onclick="closeSettings()">Cancel</button>
                <button class="btn" style="background: var(--accent-color);" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <div id="pdf-preview-modal" class="modal-overlay">
        <div class="modal-box pdf-modal-box">
            <h3>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="M9 15l3 3 3-3"/></svg>
                PDF Generated Successfully
            </h3>
            <div class="pdf-mobile-msg">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                <h4>Your PDF is ready!</h4>
                <p style="font-size: 14px; opacity: 0.7; margin-top: 10px;">Click the download button below to save it to your device.</p>
            </div>
            <iframe id="pdf-iframe"></iframe>
            <div class="modal-actions">
                <button class="btn" style="background: var(--border-color); color: var(--text-main);" onclick="closePreview()">Cancel</button>
                <button class="btn" style="background: #27ae60;" onclick="confirmDownload()">Download PDF</button>
            </div>
        </div>
    </div>

    <div id="loading-modal">
        <div class="spinner"></div>
        <div id="loading-text">Processing...</div>
    </div>

    <div id="toast">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        <span id="toast-msg">Action Successful</span>
    </div>

    <script>
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.isTrusted) event.preventDefault();
        });

        const CLIENT_ID = '178145714192-q1ovdc6qnb985j5mba5cs1501fknlplk.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';

        let tokenClient;
        let userAccessToken = null;
        let gisInited = false;
        let currentDriveFileId = null; 
        let currentProjectName = "Storyboard Maker";

        let autoSaveTimer = null;
        let isAutoSaveEnabled = false;
        let isAutoShotEnabled = true; // DEFAULT ON
        let autoSaveIntervalMs = 5 * 60 * 1000;

        let pendingAction = null;
        let pendingFileName = null;
        let pendingIsAutoSave = false;

        let lastScrollTop = 0;
        window.addEventListener('scroll', () => {
            const navbar = document.getElementById('main-navbar');
            if (window.innerWidth <= 800) {
                let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                if (scrollTop > lastScrollTop && scrollTop > 70) navbar.classList.add('hidden');
                else navbar.classList.remove('hidden');
                lastScrollTop = scrollTop;
            } else {
                navbar.classList.remove('hidden');
            }
        });

        let notifHistory = [];
        
        function addNotification(message) {
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            notifHistory.unshift({ message, time });
            if (notifHistory.length > 20) notifHistory.pop(); 
            renderNotifications();
            
            document.getElementById('notif-badge').style.display = 'block';
            
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = message;
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        function renderNotifications() {
            const list = document.getElementById('notif-list');
            if (notifHistory.length === 0) {
                list.innerHTML = `<div class="notif-empty">No notifications yet</div>`;
                return;
            }
            list.innerHTML = notifHistory.map(n => `
                <div class="notif-item">
                    <span class="msg">${n.message}</span>
                    <span class="time">${n.time}</span>
                </div>
            `).join('');
        }

        function clearNotifications() {
            notifHistory = [];
            renderNotifications();
            document.getElementById('notif-badge').style.display = 'none';
        }

        // --- GOOGLE API FORCED LOADER FIX ---
        let isGoogleApiLoading = false;
        function ensureGoogleApi(callback) {
            if (typeof google !== 'undefined' && google.accounts) {
                if (!tokenClient) gisLoaded(); 
                if (tokenClient) callback();
                return;
            }
            if (isGoogleApiLoading) {
                showToast("Google Services loading... please wait.");
                return;
            }
            isGoogleApiLoading = true;
            showLoader("Starting Google Services...");

            const script = document.createElement('script');
            script.src = "https://accounts.google.com/gsi/client";
            script.onload = () => {
                isGoogleApiLoading = false;
                hideLoader();
                gisLoaded(); 
                setTimeout(() => {
                    if (tokenClient) callback();
                    else addNotification("System error: Client init failed.");
                }, 100);
            };
            script.onerror = () => {
                isGoogleApiLoading = false;
                hideLoader();
                addNotification("Google API Blocked! Ad-blocker disable karein.");
            };
            document.body.appendChild(script);
        }

        function gisLoaded() {
            try {
                if (typeof google === 'undefined' || !google.accounts) return;
                if (tokenClient) return;

                tokenClient = google.accounts.oauth2.initTokenClient({ 
                    client_id: CLIENT_ID, 
                    scope: SCOPES, 
                    callback: (resp) => {
                        if (resp.error) {
                            console.error("Auth Error:", resp.error);
                            addNotification("Authentication Failed!");
                            return;
                        }
                        userAccessToken = resp.access_token;
                        localStorage.setItem('sbp_access_token', userAccessToken);
                        localStorage.setItem('sbp_token_expiry', Date.now() + (resp.expires_in * 1000));
                        fetchUserProfile(userAccessToken);
                        
                        if (pendingAction === 'save') {
                            executeDriveUpload(userAccessToken, pendingFileName, pendingIsAutoSave);
                            pendingAction = null;
                        } else if (pendingAction === 'open') {
                            fetchDriveFilesList();
                            pendingAction = null;
                        }
                    },
                    error_callback: (error) => {
                        console.error("GSI Error:", error);
                        addNotification("Popup blocked ya Sign In cancel ho gaya.");
                    }
                });
                gisInited = true;
                restoreSession(); 
            } catch (e) {
                console.error("GSI Init Error:", e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings(); 
            addPage();
        });

        function restoreSession() {
            const savedProfileInfo = localStorage.getItem('sbp_user_profile');
            if (savedProfileInfo) {
                updateProfileUI(JSON.parse(savedProfileInfo));
            }
            const savedToken = localStorage.getItem('sbp_access_token');
            const tokenExpiry = localStorage.getItem('sbp_token_expiry');
            if (savedToken && tokenExpiry && Date.now() < parseInt(tokenExpiry) - 60000) {
                userAccessToken = savedToken;
            }
        }

        function updateProfileUI(data) {
            if(data.picture) document.getElementById('nav-profile-pic').src = data.picture;
            if(data.name) {
                document.getElementById('user-name').innerText = data.name;
                document.getElementById('user-email').innerText = data.email;
                document.getElementById('user-info-section').style.display = 'block';
                document.getElementById('btn-login').style.display = 'none'; 
                document.getElementById('btn-logout').style.display = 'flex'; 
            }
        }

        function toggleMenu(e, menuId) {
            e.stopPropagation();
            const allMenus = document.querySelectorAll('.dropdown-menu');
            allMenus.forEach(menu => { if (menu.id !== menuId) menu.classList.remove('show'); });
            document.getElementById(menuId).classList.toggle("show");
            if (menuId === 'notifMenu') document.getElementById('notif-badge').style.display = 'none';
        }
        
        window.onclick = function(e) {
            if (!e.target.closest('.menu-container')) {
                const dropdowns = document.getElementsByClassName("dropdown-menu");
                for (let i = 0; i < dropdowns.length; i++) dropdowns[i].classList.remove('show');
            }
        }

        document.addEventListener('input', (e) => {
            if (e.target.classList.contains('input-project')) {
                document.querySelectorAll('.input-project').forEach(input => {
                    input.value = e.target.value; input.setAttribute('value', e.target.value);
                });
            }
            if (e.target.classList.contains('input-scene')) {
                document.querySelectorAll('.input-scene').forEach(input => {
                    input.value = e.target.value; input.setAttribute('value', e.target.value);
                });
            }
            if (e.target.classList.contains('shot-input')) {
                e.target.setAttribute('value', e.target.value);
            }
        });

        function handleSingleSelect(checkbox) {
            if (checkbox.checked) {
                const container = checkbox.closest('.checkboxes');
                container.querySelectorAll('input[type="checkbox"]').forEach(box => {
                    if (box !== checkbox) box.checked = false;
                });
            }
        }

        function handleText(textarea) {
            const maxChars = 200;
            if (textarea.value.length > maxChars) textarea.value = textarea.value.substring(0, maxChars);
            while (textarea.scrollHeight > textarea.clientHeight && textarea.value.length > 0) {
                textarea.value = textarea.value.substring(0, textarea.value.length - 1);
            }
            const counter = textarea.closest('.notes-container').querySelector('.word-counter');
            if (counter) counter.innerText = textarea.value.length + "/" + maxChars;
        }

        function applyAutoShotNumbering() {
            if (!isAutoShotEnabled) return;
            const allShotInputs = document.querySelectorAll('#storyboard-container .shot-input');
            allShotInputs.forEach((input, index) => {
                if (!input.value.trim()) {
                    input.value = index + 1;
                    input.setAttribute('value', index + 1);
                }
            });
        }

        function addPage() {
            const container = document.getElementById('storyboard-container');
            const template = document.getElementById('page-template').querySelector('.page');
            const newPage = template.cloneNode(true);
            
            const existingProject = container.querySelector('.input-project');
            const existingScene = container.querySelector('.input-scene');
            if(existingProject) { newPage.querySelector('.input-project').value = existingProject.value; newPage.querySelector('.input-project').setAttribute('value', existingProject.value); }
            if(existingScene) { newPage.querySelector('.input-scene').value = existingScene.value; newPage.querySelector('.input-scene').setAttribute('value', existingScene.value); }

            newPage.querySelectorAll('.image-container img').forEach(img => img.removeAttribute('src'));

            container.appendChild(newPage);
            updatePageNumbers();
            applyAutoShotNumbering();
            
            if(container.children.length > 1) newPage.scrollIntoView({ behavior: 'smooth' });
        }

        function updatePageNumbers() {
            const pages = document.querySelectorAll('#storyboard-container .page');
            pages.forEach((page, index) => {
                page.querySelector('.page-num').value = index + 1;
                page.querySelector('.page-total').value = pages.length;
            });
        }

        let pageToDelete = null;
        function deletePage(btn) { pageToDelete = btn.closest('.page'); document.getElementById('delete-confirm-modal').style.display = 'flex'; }
        function closeDeleteModal() { document.getElementById('delete-confirm-modal').style.display = 'none'; pageToDelete = null; }
        function confirmDeletePage() { if (pageToDelete) { pageToDelete.remove(); updatePageNumbers(); } closeDeleteModal(); }

        // --- 100% NATIVE IMAGE COMPRESSION (No 3rd Party Plugin) ---
        function handleImageUpload(event, container) {
            const file = event.target.files[0];
            if (!file) return;

            showLoader("Compressing Image...");
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const MAX_WIDTH = 800;
                    const MAX_HEIGHT = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) { height = Math.round(height * MAX_WIDTH / width); width = MAX_WIDTH; }
                    } else {
                        if (height > MAX_HEIGHT) { width = Math.round(width * MAX_HEIGHT / height); height = MAX_HEIGHT; }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.6); // 60% quality JPEG

                    const displayImg = container.querySelector('img'); 
                    displayImg.src = compressedDataUrl; 
                    displayImg.style.display = 'block';
                    container.classList.add('has-image');
                    hideLoader();
                };
                img.onerror = () => { hideLoader(); addNotification("Error loading image."); };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            event.target.value = ''; 
        }

        function openSettings() {
            document.getElementById('dropdownMenu').classList.remove('show');
            document.getElementById('autoSaveToggle').checked = isAutoSaveEnabled;
            document.getElementById('autoShotToggle').checked = isAutoShotEnabled;
            document.getElementById('autoSaveInterval').value = autoSaveIntervalMs / 60000;
            document.getElementById('darkThemeToggle').checked = document.body.classList.contains('dark-theme');
            document.getElementById('settings-modal').style.display = 'flex';
        }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
        
        function saveSettings() {
            isAutoSaveEnabled = document.getElementById('autoSaveToggle').checked;
            isAutoShotEnabled = document.getElementById('autoShotToggle').checked;
            autoSaveIntervalMs = parseInt(document.getElementById('autoSaveInterval').value) * 60000;
            const isDark = document.getElementById('darkThemeToggle').checked;
            
            if(isDark) document.body.classList.add('dark-theme');
            else document.body.classList.remove('dark-theme');

            localStorage.setItem('sbp_autosave', isAutoSaveEnabled);
            localStorage.setItem('sbp_autoshot', isAutoShotEnabled);
            localStorage.setItem('sbp_interval', autoSaveIntervalMs);
            localStorage.setItem('sbp_dark', isDark);
            
            if (isAutoShotEnabled) applyAutoShotNumbering();
            
            manageAutoSaveTimer();
            closeSettings();
            addNotification('Settings saved successfully');
        }

        function loadSettings() {
            const savedToggle = localStorage.getItem('sbp_autosave');
            const savedShotToggle = localStorage.getItem('sbp_autoshot');
            const savedInterval = localStorage.getItem('sbp_interval');
            const savedDark = localStorage.getItem('sbp_dark');
            
            if (savedToggle !== null) isAutoSaveEnabled = savedToggle === 'true';
            if (savedShotToggle !== null) isAutoShotEnabled = savedShotToggle === 'true';
            else isAutoShotEnabled = true; // default true if not set
            
            if (savedInterval !== null) autoSaveIntervalMs = parseInt(savedInterval);
            if (savedDark === 'true') document.body.classList.add('dark-theme');
            
            manageAutoSaveTimer();
        }

        function manageAutoSaveTimer() {
            if (autoSaveTimer) clearInterval(autoSaveTimer);
            if (isAutoSaveEnabled) {
                autoSaveTimer = setInterval(() => {
                    if (currentDriveFileId && userAccessToken !== null) {
                        executeDriveUpload(userAccessToken, currentProjectName, true);
                    }
                }, autoSaveIntervalMs);
            }
        }

        function getProjectDataJSON(nameOverride) {
            const container = document.getElementById('storyboard-container');
            const projectName = nameOverride || container.querySelector('.input-project')?.value || 'Untitled Storyboard';
            const sceneName = container.querySelector('.input-scene')?.value || '';
            let projectData = { format: "StoryboardProject", version: "1.0", projectName: projectName, scene: sceneName, pages: [] };

            container.querySelectorAll(':scope > .page').forEach(pageElement => {
                let pageData = { panels: [] };
                pageElement.querySelectorAll('.panel').forEach(panel => {
                    let panelData = { shot: '', checkbox: null, text: '', imageBase64: '' };
                    panelData.shot = panel.querySelector('.shot-input').value;
                    panelData.text = panel.querySelector('.notes-textarea').value;
                    const checkedBox = panel.querySelector('input[type="checkbox"]:checked');
                    if(checkedBox) panelData.checkbox = checkedBox.value;
                    const img = panel.querySelector('img');
                    if(img.src && img.src.startsWith('data:image')) panelData.imageBase64 = img.src;
                    pageData.panels.push(panelData);
                });
                projectData.pages.push(pageData);
            });
            return projectData;
        }

        function loadProjectData(data) {
            if(data.format !== "StoryboardProject") return alert("Invalid file format!");
            const container = document.getElementById('storyboard-container');
            container.innerHTML = ''; 
            
            data.pages.forEach(page => {
                addPage(); const newPage = container.lastElementChild;
                newPage.querySelector('.input-project').value = data.projectName || '';
                newPage.querySelector('.input-scene').value = data.scene || '';
                const panels = newPage.querySelectorAll('.panel');
                page.panels.forEach((pData, index) => {
                    if(!panels[index]) return;
                    panels[index].querySelector('.shot-input').value = pData.shot || '';
                    const textarea = panels[index].querySelector('.notes-textarea');
                    textarea.value = pData.text || ''; handleText(textarea); 
                    if(pData.checkbox) { const cb = panels[index].querySelector(`input[value="${pData.checkbox}"]`); if(cb) cb.checked = true; }
                    if(pData.imageBase64) {
                        const img = panels[index].querySelector('img'); img.src = pData.imageBase64; img.style.display = 'block';
                        panels[index].querySelector('.image-container').classList.add('has-image');
                    }
                });
            });
            updatePageNumbers();
            applyAutoShotNumbering();
            
            if(data.projectName) {
                currentProjectName = data.projectName;
                document.getElementById('app-heading-text').innerText = currentProjectName;
            }
            addNotification("Project loaded successfully");
        }

        async function fetchUserProfile(token) {
            try {
                const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { Authorization: `Bearer ${token}` } });
                const data = await res.json();
                const profileData = { name: data.name, email: data.email, picture: data.picture };
                localStorage.setItem('sbp_user_profile', JSON.stringify(profileData)); 
                updateProfileUI(profileData);
                addNotification(`Welcome back, ${data.name.split(' ')[0]}!`);
            } catch(e) { console.error('Failed to fetch profile', e); }
        }

        function signInToGoogle() {
            document.getElementById("dropdownMenu").classList.remove("show");
            ensureGoogleApi(() => {
                try { tokenClient.requestAccessToken({prompt: 'consent'}); } 
                catch (err) { console.error("Sign-In Error:", err); addNotification('Error starting Sign-In.'); }
            });
        }

        function signOutFromGoogle() {
            document.getElementById("dropdownMenu").classList.remove("show");
            localStorage.removeItem('sbp_access_token');
            localStorage.removeItem('sbp_token_expiry');
            localStorage.removeItem('sbp_user_profile');
            userAccessToken = null;
            document.getElementById('nav-profile-pic').src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='38' height='38' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'></path><circle cx='12' cy='7' r='4'></circle></svg>";
            document.getElementById('user-info-section').style.display = 'none';
            document.getElementById('btn-login').style.display = 'flex';
            document.getElementById('btn-logout').style.display = 'none';
            addNotification("Signed out successfully");
        }

        function openFromDrive() {
            document.getElementById("dropdownMenu").classList.remove("show");
            ensureGoogleApi(() => {
                if (userAccessToken === null) { pendingAction = 'open'; tokenClient.requestAccessToken({prompt: ''}); } 
                else { fetchDriveFilesList(); }
            });
        }

        async function fetchDriveFilesList() {
            showLoader("Fetching projects...");
            try {
                const query = encodeURIComponent(`name contains '.sbp' and trashed=false`);
                const url = `https://www.googleapis.com/drive/v3/files?q=${query}&fields=files(id,name,modifiedTime)&orderBy=modifiedTime desc`;
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${userAccessToken}` }});
                const data = await res.json();
                
                const listContainer = document.getElementById('drive-files-list');
                listContainer.innerHTML = '';
                
                if (data.files && data.files.length > 0) {
                    data.files.forEach(file => {
                        const div = document.createElement('div'); div.className = 'file-item';
                        const date = new Date(file.modifiedTime).toLocaleDateString();
                        div.innerHTML = `
                            <span style="display:flex;align-items:center;gap:8px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                                ${file.name.replace('.sbp', '')}
                            </span> 
                            <span style="font-size:11px; color:var(--muted-text)">${date}</span>
                        `;
                        div.onclick = () => loadFileFromDrive(file.id, file.name);
                        listContainer.appendChild(div);
                    });
                    document.getElementById('no-files-msg').style.display = 'none';
                    listContainer.style.display = 'block';
                } else {
                    listContainer.style.display = 'none';
                    document.getElementById('no-files-msg').style.display = 'block';
                }
                hideLoader();
                document.getElementById('open-drive-modal').style.display = 'flex';
            } catch(err) {
                hideLoader();
                if(err.message && err.message.includes('401')) { userAccessToken = null; addNotification("Session expired, logging in again..."); openFromDrive(); } 
                else { alert("Error fetching files from Drive."); }
            }
        }

        async function loadFileFromDrive(fileId, fileName) {
            closeOpenModal();
            showLoader("Loading project...");
            try {
                const res = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { headers: { 'Authorization': `Bearer ${userAccessToken}` } });
                const data = await res.json();
                currentDriveFileId = fileId; 
                loadProjectData(data);
                hideLoader();
            } catch(err) { hideLoader(); alert("Error loading project."); }
        }

        function closeOpenModal() { document.getElementById('open-drive-modal').style.display = 'none'; }
        function showLoader(text) { document.getElementById('loading-text').innerText = text; document.getElementById('loading-modal').style.display = 'flex'; }
        function hideLoader() { document.getElementById('loading-modal').style.display = 'none'; }

        function initiateDriveSave() {
            if (CLIENT_ID.includes('YOUR_GOOGLE_CLIENT_ID_HERE')) return alert('Setup is required once in the code!');
            if (currentDriveFileId) { triggerGoogleAuth(currentProjectName); } 
            else {
                const firstProjectInput = document.querySelector('.input-project');
                document.getElementById('driveFileNameInput').value = firstProjectInput && firstProjectInput.value ? firstProjectInput.value : "My Storyboard";
                document.getElementById('save-name-modal').style.display = 'flex';
            }
        }

        function closeSaveNameModal() { document.getElementById('save-name-modal').style.display = 'none'; }
        function confirmDriveSave() {
            const fileName = document.getElementById('driveFileNameInput').value.trim() || "Untitled Storyboard";
            closeSaveNameModal();
            triggerGoogleAuth(fileName);
        }

        function triggerGoogleAuth(fileName, isAutoSave = false) {
            ensureGoogleApi(() => {
                if (userAccessToken === null) {
                    pendingAction = 'save'; pendingFileName = fileName; pendingIsAutoSave = isAutoSave;
                    tokenClient.requestAccessToken({prompt: ''}); 
                } else { executeDriveUpload(userAccessToken, fileName, isAutoSave); }
            });
        }

        let cachedMainFolderId = null;
        let cachedSubFolderIds = {};

        async function executeDriveUpload(accessToken, fileName, isAutoSave = false) {
            if(!isAutoSave) showLoader("Connecting to Google Drive...");
            try {
                const projectData = getProjectDataJSON(fileName);
                let projName = fileName.replace(/[^a-zA-Z0-9 ]/g, "").trim() || "Untitled";
                const finalFileName = `${projName}.sbp`;
                const fileContent = JSON.stringify(projectData);
                const fileBlob = new Blob([fileContent], {type: 'application/json'});

                if (currentDriveFileId) {
                    if(!isAutoSave) showLoader("Updating project...");
                    const updateRes = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${currentDriveFileId}?uploadType=media`, {
                        method: 'PATCH', headers: new Headers({ 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }), body: fileBlob
                    });
                    if(updateRes.ok) { 
                        if(isAutoSave) addNotification("Project auto-saved."); else addNotification("Project updated in Drive"); 
                        currentProjectName = fileName;
                        document.getElementById('app-heading-text').innerText = currentProjectName;
                        document.querySelectorAll('.input-project').forEach(input => input.value = currentProjectName);
                        if(!isAutoSave) hideLoader();
                        return;
                    } 
                    else { currentDriveFileId = null; }
                }

                if(!isAutoSave) showLoader("Checking folders...");
                const mainFolderName = "Storyboard Maker Projects";
                
                if (!cachedMainFolderId) {
                    const mainSearchRes = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(`mimeType='application/vnd.google-apps.folder' and name='${mainFolderName}' and trashed=false`)}&fields=files(id,name)`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                    const mainSearchData = await mainSearchRes.json();
                    if (mainSearchData.files && mainSearchData.files.length > 0) { cachedMainFolderId = mainSearchData.files[0].id; } 
                    else {
                        const createMainRes = await fetch('https://www.googleapis.com/drive/v3/files', {
                            method: 'POST', headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: mainFolderName, mimeType: 'application/vnd.google-apps.folder' })
                        });
                        cachedMainFolderId = (await createMainRes.json()).id;
                    }
                }

                let subFolderId = cachedSubFolderIds[projName];
                if (!subFolderId) {
                    const subSearchRes = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(`mimeType='application/vnd.google-apps.folder' and name='${projName}' and '${cachedMainFolderId}' in parents and trashed=false`)}&fields=files(id,name)`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                    const subSearchData = await subSearchRes.json();
                    if (subSearchData.files && subSearchData.files.length > 0) { subFolderId = subSearchData.files[0].id; } 
                    else {
                        const createSubRes = await fetch('https://www.googleapis.com/drive/v3/files', {
                            method: 'POST', headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: projName, mimeType: 'application/vnd.google-apps.folder', parents: [cachedMainFolderId] })
                        });
                        subFolderId = (await createSubRes.json()).id;
                    }
                    cachedSubFolderIds[projName] = subFolderId;
                }

                if (!currentDriveFileId) {
                    const fileSearchRes = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(`name='${finalFileName}' and '${subFolderId}' in parents and trashed=false`)}&fields=files(id,name)`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                    const fileSearchData = await fileSearchRes.json();
                    if (fileSearchData.files && fileSearchData.files.length > 0) currentDriveFileId = fileSearchData.files[0].id;
                }

                if (currentDriveFileId) {
                    if(!isAutoSave) showLoader("Updating project...");
                    const updateRes = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${currentDriveFileId}?uploadType=media`, {
                        method: 'PATCH', headers: new Headers({ 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }), body: fileBlob
                    });
                    if(updateRes.ok) { if(isAutoSave) addNotification("Project auto-saved."); else addNotification("Project updated in Drive"); } 
                    else { throw new Error("Update failed."); }
                } else {
                    if(!isAutoSave) showLoader("Saving your work...");
                    const metadata = { name: finalFileName, mimeType: 'application/json', parents: [subFolderId] };
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                    form.append('file', fileBlob);
                    const uploadRes = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                        method: 'POST', headers: new Headers({ 'Authorization': `Bearer ${accessToken}` }), body: form
                    });
                    if(uploadRes.ok) { currentDriveFileId = (await uploadRes.json()).id; if(!isAutoSave) addNotification("Project saved to Drive!"); } 
                    else { throw new Error("Upload failed."); }
                }

                currentProjectName = fileName;
                document.getElementById('app-heading-text').innerText = currentProjectName;
                document.querySelectorAll('.input-project').forEach(input => input.value = currentProjectName);
            } catch(err) {
                if(err.message && err.message.includes('401')) {
                    userAccessToken = null; if(!isAutoSave) { addNotification("Session expired, trying again..."); triggerGoogleAuth(fileName, false); }
                } else {
                    if(!isAutoSave) alert("Error saving to Drive. Check console."); else addNotification("Auto-save failed");
                }
            } finally { if(!isAutoSave) hideLoader(); }
        }

        async function generatePurePDF() {
            const btn = document.getElementById('pdf-btn'); 
            const originalBtnHTML = btn.innerHTML; 
            btn.innerHTML = `<div class="spinner" style="width:16px;height:16px;border-width:2px;margin:0;"></div>`; 
            btn.disabled = true; 
            showLoader("Generating perfect PDF...");

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                
                const textColor = "#111111";
                const labelColor = "#333333";
                const lineColor = "#555555";
                const margin = 15;
                const pw = 210;
                const ph = 297;
                const contentW = pw - (margin * 2);

                const pages = document.querySelectorAll('#storyboard-container .page');
                
                pages.forEach((page, pageIndex) => {
                    if (pageIndex > 0) doc.addPage();

                    const projName = page.querySelector('.input-project').value || '';
                    const sceneName = page.querySelector('.input-scene').value || '';

                    doc.setFontSize(10);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(labelColor);
                    doc.text("PROJECT", margin, margin + 5);
                    
                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(textColor);
                    doc.text(projName, margin + 20, margin + 5);
                    doc.setDrawColor(lineColor);
                    doc.line(margin + 18, margin + 6, margin + 70, margin + 6);

                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(labelColor);
                    doc.text("SCENE", margin + 80, margin + 5);
                    
                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(textColor);
                    doc.text(sceneName, margin + 95, margin + 5);
                    doc.line(margin + 93, margin + 6, margin + 140, margin + 6);

                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(labelColor);
                    doc.text("PAGE", margin + 150, margin + 5);
                    
                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(textColor);
                    const pageText = `${pageIndex + 1} of ${pages.length}`;
                    doc.text(pageText, margin + 165, margin + 5);
                    doc.line(margin + 163, margin + 6, margin + 180, margin + 6);

                    const panels = page.querySelectorAll('.panel');
                    const panelHeight = 80;
                    
                    panels.forEach((panel, pIndex) => {
                        const startY = margin + 15 + (pIndex * (panelHeight + 5)); 

                        doc.setDrawColor(lineColor);
                        doc.rect(margin, startY, contentW, panelHeight);
                        doc.line(margin, startY + 8, margin + contentW, startY + 8);
                        doc.line(margin + 45, startY, margin + 45, startY + 8); 
                        doc.setFontSize(8);
                        doc.setFont("helvetica", "bold");
                        doc.setTextColor(labelColor);
                        doc.text("SHOT #:", margin + 2, startY + 5.5);
                        
                        const shotVal = panel.querySelector('.shot-input').value || '';
                        doc.setFont("helvetica", "normal");
                        doc.setTextColor(textColor);
                        doc.text(shotVal, margin + 16, startY + 5.5);

                        const cbTypes = ['ECU', 'CU', 'MCU', 'MS', 'WS', 'EWS'];
                        const checkedVal = panel.querySelector('input[type="checkbox"]:checked')?.value;
                        
                        let cbX = margin + 50;
                        cbTypes.forEach(type => {
                            doc.setDrawColor(lineColor);
                            if (checkedVal === type) {
                                doc.setFillColor("#000000");
                                doc.rect(cbX, startY + 2.5, 3.5, 3.5, 'FD'); 
                            } else {
                                doc.rect(cbX, startY + 2.5, 3.5, 3.5); 
                            }
                            doc.setFont("helvetica", "bold");
                            doc.setFontSize(8);
                            doc.setTextColor(textColor);
                            doc.text(type, cbX + 5, startY + 5.5);
                            cbX += 20; 
                        });

                        const imgBoxWidth = contentW * 0.55;
                        doc.line(margin + imgBoxWidth, startY + 8, margin + imgBoxWidth, startY + panelHeight);

                        const imgEl = panel.querySelector('.image-container img');
                        if (imgEl && imgEl.src && imgEl.src.startsWith('data:image')) {
                            try {
                                const boxW = imgBoxWidth - 2; 
                                const boxH = (panelHeight - 8) - 2;
                                const imgW = imgEl.naturalWidth || 800; 
                                const imgH = imgEl.naturalHeight || 600;
                                const ratio = Math.min(boxW / imgW, boxH / imgH);
                                const finalW = imgW * ratio;
                                const finalH = imgH * ratio;
                                const imgX = margin + 1 + (boxW - finalW) / 2;
                                const imgY = startY + 9 + (boxH - finalH) / 2;
                                
                                doc.addImage(imgEl.src, 'JPEG', imgX, imgY, finalW, finalH, undefined, 'FAST');
                            } catch (e) { console.log("Failed to draw image", e); }
                        }

                        doc.setFont("helvetica", "bold");
                        doc.setFontSize(9);
                        doc.setTextColor(labelColor);
                        doc.text("Scene Description:", margin + imgBoxWidth + 3, startY + 13);

                        const notes = panel.querySelector('.notes-textarea').value || '';
                        doc.setFont("helvetica", "normal");
                        doc.setTextColor(textColor);
                        
                        const textLines = doc.splitTextToSize(notes, contentW - imgBoxWidth - 6);
                        doc.text(textLines, margin + imgBoxWidth + 3, startY + 18);
                    });
                });

                const pdfBlob = doc.output('blob');
                currentPdfUrl = URL.createObjectURL(pdfBlob);
                document.getElementById('pdf-iframe').src = currentPdfUrl;
                document.getElementById('pdf-preview-modal').style.display = 'flex';
                addNotification("PDF Generated Perfectly!");

            } catch (err) { 
                console.error(err);
                alert("PDF Error. Try again."); 
            } finally { 
                hideLoader();
                btn.innerHTML = originalBtnHTML; 
                btn.disabled = false; 
            }
        }

        function closePreview() { document.getElementById('pdf-preview-modal').style.display = 'none'; document.getElementById('pdf-iframe').src = ''; if (currentPdfUrl) { URL.revokeObjectURL(currentPdfUrl); currentPdfUrl = null; } }
        function confirmDownload() { if (currentPdfUrl) { const a = document.createElement('a'); a.href = currentPdfUrl; a.download = currentProjectName + '.pdf'; document.body.appendChild(a); a.click(); document.body.removeChild(a); closePreview(); } }
    </script>
</body>
</html>
